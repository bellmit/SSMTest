package cn.gtmap.msurveyplat.promanage.core.service.impl;


import cn.gtmap.msurveyplat.common.annotion.SystemLog;
import cn.gtmap.msurveyplat.common.core.support.mybatis.mapper.EntityMapper;
import cn.gtmap.msurveyplat.common.core.support.mybatis.mapper.Example;
import cn.gtmap.msurveyplat.common.core.support.mybatis.page.repository.Repository;
import cn.gtmap.msurveyplat.common.domain.dchyxmgl.*;
import cn.gtmap.msurveyplat.common.dto.*;
import cn.gtmap.msurveyplat.common.util.*;
import cn.gtmap.msurveyplat.promanage.core.mapper.DchyXmglChxmClsxMapper;
import cn.gtmap.msurveyplat.promanage.core.mapper.DchyXmglChxmMapper;
import cn.gtmap.msurveyplat.promanage.core.mapper.DchyXmglJsdwMapper;
import cn.gtmap.msurveyplat.promanage.core.service.CommissionFilingService;
import cn.gtmap.msurveyplat.promanage.core.service.DchyXmglZdService;
import cn.gtmap.msurveyplat.promanage.core.service.MessagePushService;
import cn.gtmap.msurveyplat.promanage.core.service.mq.service.PushDataToMqService;
import cn.gtmap.msurveyplat.promanage.utils.Constants;
import cn.gtmap.msurveyplat.promanage.utils.ConstructionCodeUtil;
import cn.gtmap.msurveyplat.promanage.utils.UserUtil;
import cn.gtmap.msurveyplat.promanage.web.utils.FileDownoadUtil;
import cn.gtmap.msurveyplat.promanage.web.utils.XmbhFormatUtil;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.gtis.common.util.UUIDGenerator;
import com.gtis.fileCenter.model.Node;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import static cn.gtmap.msurveyplat.promanage.utils.PlatformUtil.getNodeService;

import java.util.*;

/**
 * @author <a href="mailto:lijingmo@gtmap.cn">lijingmo</a>
 * @version 1.o, 2020-12-09
 * description
 */
@Service
public class CommissionFilingServiceImpl implements CommissionFilingService {

    @Autowired
    PushDataToMqService pushDataToMqService;

    @Autowired
    DchyXmglChxmMapper dchyXmglChxmMapper;

    @Autowired
    DchyXmglZdService dchyXmglZdService;

    @Autowired
    EntityMapper entityMapper;

    @Autowired
    Repository repository;

    @Autowired
    MessagePushService messagePushService;

    @Autowired
    DchyXmglChxmClsxMapper dchyXmglChxmClsxMapper;

    @Autowired
    DchyXmglJsdwMapper dchyXmglJsdwMapper;

    private Logger logger = LoggerFactory.getLogger(CommissionFilingServiceImpl.class);

    @Override
    @Transactional
    @SystemLog(czmkMc = ProLog.CZMK_BALB_MC, czmkCode = ProLog.CZMK_BALB_CODE, czlxMc = ProLog.CZLX_SAVE_MC, czlxCode = ProLog.CZLX_SAVE_CODE, ssmkid = ProLog.SSMKID_HTBASL_CODE)
    public boolean reviewCommission(Map<String, Object> map) {
        logger.info("****************************线下备案审核后推送线上备份开始********************************");
        //消息提醒推送
        DchyXmglXxtxDto dchyXmglXxtxDto = new DchyXmglXxtxDto();
        String chxmid = CommonUtil.formatEmptyValue(map.get("chxmid"));
        String sftg = CommonUtil.formatEmptyValue(map.get("sftg"));
        String gcmc = CommonUtil.formatEmptyValue(map.get("gcmc"));
        String wtdw = CommonUtil.formatEmptyValue(map.get("wtdw"));
        String shyj = CommonUtil.formatEmptyValue(map.get("shyj"));
        try {
            String slr = UserUtil.getCurrentUserId();
            Date slsj = new Date();
            DchyXmglChxm dchyXmglChxm = entityMapper.selectByPrimaryKey(DchyXmglChxm.class, chxmid);
            dchyXmglChxm.setSlr(slr);
            dchyXmglChxm.setSlsj(slsj);
            dchyXmglChxm.setChxmid(chxmid);
            dchyXmglChxm.setXmzt(Constants.DCHY_XMGL_CHXM_XMZT_YSL);
            //更新委托状态
            String wtzt = dchyXmglChxm.getWtzt();
            if (StringUtils.equals(sftg, Constants.SHTG)) {
                //备案审核通过
                if (StringUtils.isNotBlank(wtzt)) {
                    dchyXmglChxm.setWtzt(Constants.WTZT_YBA); //委托状态已备案
                }
            } else if (StringUtils.equals(sftg, Constants.SHBTG)) {
                //备案审核不通过
                if (StringUtils.isNotBlank(wtzt)) {
                    dchyXmglChxm.setWtzt(Constants.WTZT_YTH); //委托状态已退回
                }
            }
            logger.info("委托状态：" + wtzt + "**********************************");
            int result = entityMapper.saveOrUpdate(dchyXmglChxm, dchyXmglChxm.getChxmid());
            if (result > 0) {
                //组织推送数据
                List<DchyXmglChxmDto> dchyXmglChxmDtoList = this.generateChxmDto(chxmid, wtzt, sftg, shyj, wtdw);

                //用户消息
                List<Map<String, Object>> chdwxxList = (List<Map<String, Object>>) map.get("chdwxx");
                List<DchyXmglYhxx> yhxxList = this.generateYhxx(gcmc, wtdw, chxmid, sftg, chdwxxList);
                //组织用户消息数据同步
                dchyXmglXxtxDto.setDchyXmglYhxxList(yhxxList);

                Map<String, Object> resultMap = new HashMap<>();
                Map<String, Object> resultMapXxtx = new HashMap<>();
                resultMap.put("saveOrUpdate", dchyXmglChxmDtoList);
                resultMapXxtx.put("saveOrUpdate", dchyXmglXxtxDto);
                pushDataToMqService.pushBaxxMsgToMq(JSON.toJSONString(resultMap));
                pushDataToMqService.pushXxtxResultTo(dchyXmglXxtxDto);

                //删掉拆分前的测绘项目
                Example exampleDelChxm = new Example(DchyXmglChxm.class);
                exampleDelChxm.createCriteria().andEqualTo("chxmid", chxmid);
                entityMapper.deleteByExampleNotNull(exampleDelChxm);
                logger.info("拆分前的测绘项目id:" +  chxmid);
                logger.info("*********************************线下备案审核推送线上备份结束***********************************");
                return true;
            }
        } catch (Exception e) {
            List<DchyXmglChxmDto> failDchyXmglChxmDtoList = Lists.newArrayList();
            DchyXmglChxmDto failDchyXmglChxmDto = new DchyXmglChxmDto();
            DchyXmglXxtxDto failDchyXmglXxtxDto = new DchyXmglXxtxDto();
            DchyXmglChxm dchyXmglChxm = entityMapper.selectByPrimaryKey(DchyXmglChxm.class, chxmid);
            dchyXmglChxm.setWtzt(Constants.WTZT_CXBA);
            failDchyXmglChxmDto.setDchyXmglChxm(dchyXmglChxm);
            failDchyXmglChxmDtoList.add(failDchyXmglChxmDto);

            //用户消息
            List<Map<String, Object>> chdwxxList = (List<Map<String, Object>>) map.get("chdwxx");
            List<DchyXmglYhxx> yhxxList = this.generateYhxx(gcmc, wtdw, chxmid, sftg, chdwxxList);
            //组织用户消息数据同步
            failDchyXmglXxtxDto.setDchyXmglYhxxList(yhxxList);

            Map<String, Object> resultMap = new HashMap<>();
            Map<String, Object> failResultMap = new HashMap<>();
            resultMap.put("saveOrUpdate", failDchyXmglChxmDtoList);
            failResultMap.put("saveOrUpdate", failDchyXmglXxtxDto);
            pushDataToMqService.pushBaxxMsgToMq(JSON.toJSONString(resultMap));
            pushDataToMqService.pushXxtxResultTo(failDchyXmglXxtxDto);
            logger.error("错误原因{}", e);
            return false;
        }
        return false;
    }

    private List<DchyXmglChxmDto> generateChxmDto(String chxmid, String wtzt, String sftg, String shyj, String wtdw) {
        List<DchyXmglChxmDto> dchyXmglChxmDtoList = Lists.newArrayList();
        //获取测绘项目涉及的测绘阶段
        Map<String, Object> paramMap = Maps.newHashMap();
        paramMap.put("chxmid", chxmid);
        List<Map<String, Object>> clsxList = dchyXmglChxmClsxMapper.queryClsxJdByChxmid(paramMap);

        if (clsxList != null) {
            //取出测绘阶段
            Set set = new HashSet();
            List newList = new ArrayList();
            for (Map clsxMap : clsxList) {
                if (set.add(MapUtils.getString(clsxMap, "FDM"))) {
                    newList.add(MapUtils.getString(clsxMap, "FDM"));
                }
            }

            //根据测绘阶段拆分
            if (CollectionUtils.isNotEmpty(newList)) {
                for (Iterator<String> it = newList.iterator(); it.hasNext(); ) {
                    List<DchyXmglChxmClsx> dchyXmglChxmClsxList = Lists.newArrayList();
                    List<DchyXmglChxmChdwxx> dchyXmglChxmChdwxxList = Lists.newArrayList();
                    List<DchyXmglSjxx> dchyXmglSjxxList = Lists.newArrayList();
                    List<DchyXmglSjcl> dchyXmglSjclList = Lists.newArrayList();
                    List<DchyXmglYbrw> dchyXmglYbrwList = Lists.newArrayList();
                    List<DchyXmglSqxx> dchyXmglSqxxList = Lists.newArrayList();
                    String cljd = it.next();
                    DchyXmglChxmDto dchyXmglChxmDto = new DchyXmglChxmDto();
                    //拆分组织测绘项目
                    DchyXmglChxm oldDchyXmglChxm = entityMapper.selectByPrimaryKey(DchyXmglChxm.class, chxmid);
                    if (oldDchyXmglChxm != null) {
                        String newChxmid = UUIDGenerator.generate18();
                        oldDchyXmglChxm.setChxmid(newChxmid);
                        oldDchyXmglChxm.setWtzt(wtzt);
                        //备案编号
                        String babh = obtainBabh(chxmid, wtdw);
                        if (StringUtils.isNotEmpty(babh)) {
                            oldDchyXmglChxm.setBabh(babh);
                        }
                        entityMapper.saveOrUpdate(oldDchyXmglChxm, oldDchyXmglChxm.getChxmid());
                        dchyXmglChxmDto.setDchyXmglChxm(oldDchyXmglChxm);

                        //拆分组织测绘项目测绘单位(目前测绘单位是单选)
                        String newChdwxxid = null;
                        Example exampleChxmChdwxx = new Example(DchyXmglChxmChdwxx.class);
                        exampleChxmChdwxx.createCriteria().andEqualTo("chxmid", chxmid);
                        List<DchyXmglChxmChdwxx> oldDchyXmglChxmChdwxxList = entityMapper.selectByExampleNotNull(exampleChxmChdwxx);
                        if (CollectionUtils.isNotEmpty(oldDchyXmglChxmChdwxxList)) {
                            for (DchyXmglChxmChdwxx oldDchyXmglChxmChdwxx : oldDchyXmglChxmChdwxxList) {
                                newChdwxxid = UUIDGenerator.generate18();
                                oldDchyXmglChxmChdwxx.setChdwxxid(newChdwxxid);
                                oldDchyXmglChxmChdwxx.setChxmid(newChxmid);
                                entityMapper.saveOrUpdate(oldDchyXmglChxmChdwxx, oldDchyXmglChxmChdwxx.getChdwxxid());
                                dchyXmglChxmChdwxxList.add(oldDchyXmglChxmChdwxx);
                            }
                            dchyXmglChxmDto.setDchyXmglChxmChdwxxList(dchyXmglChxmChdwxxList);
                        }

                        //根据测绘事项拆分收件信息
                        List<Map<String, List>> fileList = new ArrayList<>();
                        List newClsxList = Lists.newArrayList();
                        List oldClsxidList = Lists.newArrayList();
                        Example exampleSjxx = new Example(DchyXmglSjxx.class);
                        exampleSjxx.createCriteria().andEqualTo("glsxid", chxmid);
                        List<DchyXmglSjxx> oldDchyXmglSjxxList = entityMapper.selectByExampleNotNull(exampleSjxx);
                        if (CollectionUtils.isNotEmpty(oldDchyXmglSjxxList)) {
                            for (DchyXmglSjxx oldDchyXmglSjxx : oldDchyXmglSjxxList) {
                                String sjxxid = oldDchyXmglSjxx.getSjxxid();
                                String newSjxxid = UUIDGenerator.generate18();
                                oldDchyXmglSjxx.setSjxxid(newSjxxid);
                                oldDchyXmglSjxx.setGlsxid(newChxmid);
                                entityMapper.saveOrUpdate(oldDchyXmglSjxx, oldDchyXmglSjxx.getSjxxid());
                                dchyXmglSjxxList.add(oldDchyXmglSjxx);

                                //拆分组织测绘项目测绘事项
                                for (Map<String, Object> clsxMap : clsxList) {
                                    if (StringUtils.equals(MapUtils.getString(clsxMap, "FDM"), cljd)) {
                                        String oldClsx = MapUtils.getString(clsxMap, "CLSX");
                                        Example exampleChxmClsx = new Example(DchyXmglChxmClsx.class);
                                        exampleChxmClsx.createCriteria().andEqualTo("chxmid", chxmid).andEqualTo("clsx", oldClsx);
                                        List<DchyXmglChxmClsx> oldDchyXmglChxmClsxList = entityMapper.selectByExampleNotNull(exampleChxmClsx);
                                        if (CollectionUtils.isNotEmpty(oldDchyXmglChxmClsxList)) {
                                            for (DchyXmglChxmClsx oldDchyXmglChxmClsx : oldDchyXmglChxmClsxList) {
                                                String oldClsxid = oldDchyXmglChxmClsx.getClsxid();
                                                oldClsxidList.add(oldClsxid);
                                                String newClsxid = UUIDGenerator.generate18();
                                                newClsxList.add(newClsxid);
                                                oldDchyXmglChxmClsx.setClsxid(newClsxid);
                                                oldDchyXmglChxmClsx.setChxmid(newChxmid);
                                                entityMapper.saveOrUpdate(oldDchyXmglChxmClsx, oldDchyXmglChxmClsx.getClsxid());
                                                dchyXmglChxmClsxList.add(oldDchyXmglChxmClsx);

                                                //根据测绘事项拆分收件材料
                                                Example exampleSjcl = new Example(DchyXmglSjcl.class);
                                                exampleSjcl.createCriteria().andEqualTo("sjxxid", sjxxid);
                                                List<DchyXmglSjcl> oldDchyXmglSjclList = entityMapper.selectByExampleNotNull(exampleSjcl);
                                                if (CollectionUtils.isNotEmpty(oldDchyXmglSjclList)) {
                                                    for (DchyXmglSjcl oldDchyXmglSjcl : oldDchyXmglSjclList) {
                                                        if(StringUtils.isNotEmpty(oldDchyXmglSjcl.getClsx())){
                                                            List<String> oldClsxList = Lists.newArrayList();
                                                            String clsx = oldDchyXmglSjcl.getClsx();
                                                            boolean status = clsx.contains(",");
                                                            if(status){
                                                                Example example = new Example(DchyXmglSjcl.class);
                                                                example.createCriteria().andEqualTo("sjxxid",newSjxxid).andEqualTo("clsx",clsx);
                                                                List<DchyXmglSjcl> newSjclList = entityMapper.selectByExampleNotNull(example);
                                                                if(CollectionUtils.isEmpty(newSjclList)){
                                                                    oldClsxList = Arrays.asList(clsx.split(Constants.DCHY_XMGL_CLSX_SEPARATOR2));//根据分号分隔转化为list
                                                                }
                                                            }else{
                                                                oldClsxList.add(clsx);
                                                            }
                                                            //判断材料的所属测量事项是否包含当前拆分阶段的测量事项
                                                            if(oldClsxList.contains(oldClsx)){
                                                                if (StringUtils.isNotEmpty(oldDchyXmglSjcl.getWjzxid())) {
                                                                    String newSjclid = UUIDGenerator.generate18();
                                                                    oldDchyXmglSjcl.setSjclid(newSjclid);
                                                                    oldDchyXmglSjcl.setSjxxid(newSjxxid);
                                                                    entityMapper.saveOrUpdate(oldDchyXmglSjcl, oldDchyXmglSjcl.getSjclid());
                                                                    dchyXmglSjclList.add(oldDchyXmglSjcl);

                                                                    List<Map<String, String>> file;
                                                                    Map<String, List> listMap = new HashMap<>();
                                                                    String wjzxid = oldDchyXmglSjcl.getWjzxid();
                                                                    if (StringUtils.isNotBlank(wjzxid)) {
                                                                        /*生成文件*/
                                                                        file = this.generateFileByWjzxid(Integer.parseInt(wjzxid));
                                                                        if(file != null){
                                                                            listMap.put(oldDchyXmglSjcl.getSjclid(), file);
                                                                            fileList.add(listMap);
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            dchyXmglChxmDto.setDchyXmglSjxxList(dchyXmglSjxxList);
                            dchyXmglChxmDto.setDchyXmglSjclList(dchyXmglSjclList);
							dchyXmglChxmDto.setDchyXmglChxmClsxList(dchyXmglChxmClsxList);
                            dchyXmglChxmDto.setFileList(fileList);
                        }
                        //拆分合同
                        List<DchyXmglHtxxDto> dchyXmglHtxxDtoList = this.generateHtxxList(chxmid, newChxmid, newChdwxxid, newClsxList, oldClsxidList);
                        dchyXmglChxmDto.setDchyXmglHtxxDtoList(dchyXmglHtxxDtoList);

                    }

                    //测绘工程
                    if (oldDchyXmglChxm != null) {
                        String chgcid = oldDchyXmglChxm.getChgcid();
                        if (StringUtils.isNotEmpty(chgcid)) {
                            DchyXmglChgc dchyXmglChgc = entityMapper.selectByPrimaryKey(DchyXmglChgc.class, chgcid);
                            dchyXmglChxmDto.setDchyXmglChgc(dchyXmglChgc);
                        }
                    }

                    //根据chxmid获取当前待办任务的dbrwid，备案后转为已办任务
                    String dbrwid = null;
                    Example sqxxExample = new Example(DchyXmglSqxx.class);
                    sqxxExample.createCriteria().andEqualTo("glsxid", chxmid);
                    List<DchyXmglSqxx> sqxxList = entityMapper.selectByExampleNotNull(sqxxExample);
                    if (CollectionUtils.isNotEmpty(sqxxList)) {
                        for (DchyXmglSqxx sqxxLists : sqxxList) {
                            String sqxxid = sqxxLists.getSqxxid();
                            Example dbrwExample = new Example(DchyXmglDbrw.class);
                            dbrwExample.createCriteria().andEqualTo("sqxxid", sqxxid);
                            List<DchyXmglDbrw> dbrwList = entityMapper.selectByExampleNotNull(dbrwExample);
                            if (CollectionUtils.isNotEmpty(dbrwList)) {
                                for (DchyXmglDbrw dbrwLists : dbrwList) {
                                    dbrwid = dbrwLists.getDbrwid();
                                    boolean shtg = StringUtils.equalsIgnoreCase(sftg, "1");
                                    /*新生成一条已办数据*/
                                    DchyXmglYbrw dchyXmglYbrw = new DchyXmglYbrw();
                                    dchyXmglYbrw.setBlryid(UserUtil.getCurrentUserId());
                                    dchyXmglYbrw.setBlyj(shyj);
                                    dchyXmglYbrw.setJssj(new Date());
                                    dchyXmglYbrw.setSqxxid(sqxxid);
                                    dchyXmglYbrw.setBljg(shtg ? Constants.INVALID : Constants.VALID);
                                    dchyXmglYbrw.setDqjd(dbrwLists.getDqjd());
                                    dchyXmglYbrw.setZrsj(dbrwLists.getZrsj());
                                    dchyXmglYbrw.setYbrwid(dbrwLists.getDbrwid());

                                    /*保存已办任务*/
                                    entityMapper.saveOrUpdate(dchyXmglYbrw, dchyXmglYbrw.getYbrwid());
                                    dchyXmglYbrwList.add(dchyXmglYbrw);

                                    DchyXmglSqxx dchyXmglSqxx = entityMapper.selectByPrimaryKey(DchyXmglSqxx.class, sqxxid);
                                    if (shtg) {
                                        dchyXmglSqxx.setSqzt(Constants.DCHY_XMGL_SQZT_TH);
                                    } else {
                                        dchyXmglSqxx.setSqzt(Constants.DCHY_XMGL_SQZT_SHTG);
                                    }
                                    int sqxx = entityMapper.saveOrUpdate(dchyXmglSqxx, sqxxid);
                                    dchyXmglSqxxList.add(dchyXmglSqxx);
                                }
                            }
                        }
                    }
                    dchyXmglChxmDtoList.add(dchyXmglChxmDto);
                }
            }

            Example sqxxExample = new Example(DchyXmglSqxx.class);
            sqxxExample.createCriteria().andEqualTo("glsxid", chxmid);
            List<DchyXmglSqxx> sqxxList = entityMapper.selectByExampleNotNull(sqxxExample);
            if (CollectionUtils.isNotEmpty(sqxxList)) {
                for (DchyXmglSqxx sqxxLists : sqxxList) {
                    String sqxxid = sqxxLists.getSqxxid();
                    Example dbrwExample = new Example(DchyXmglDbrw.class);
                    dbrwExample.createCriteria().andEqualTo("sqxxid", sqxxid);
                    List<DchyXmglDbrw> dbrwList = entityMapper.selectByExampleNotNull(dbrwExample);
                    if (CollectionUtils.isNotEmpty(dbrwList)) {
                        for (DchyXmglDbrw dbrwLists : dbrwList) {
                            String dbrwid = dbrwLists.getDbrwid();
                            //删除待办任务
                            entityMapper.deleteByPrimaryKey(DchyXmglDbrw.class, dbrwid);
                        }
                    }
                }
            }

            //删除原关系表
            Example exampleDelClsxHtxx = new Example(DchyXmglClsxHtxxGx.class);
            exampleDelClsxHtxx.createCriteria().andEqualTo("chxmid", chxmid);
            entityMapper.deleteByExampleNotNull(exampleDelClsxHtxx);

            Example exampleDelHtxxChdwxx = new Example(DchyXmglHtxxChdwxxGx.class);
            exampleDelHtxxChdwxx.createCriteria().andEqualTo("chxmid", chxmid);
            entityMapper.deleteByExampleNotNull(exampleDelHtxxChdwxx);

            Example exampleDelClsxChdwxx = new Example(DchyXmglClsxChdwxxGx.class);
            exampleDelClsxChdwxx.createCriteria().andEqualTo("chxmid", chxmid);
            entityMapper.deleteByExampleNotNull(exampleDelClsxChdwxx);
        }

        return dchyXmglChxmDtoList;
    }

    private List<Map<String, String>> generateFileByWjzxid(int nodeId) {
        List<Map<String, String>> sjclList = new ArrayList<>();
        try {
            List<Node> nodeList = getNodeService().getChildNodes(nodeId);
            if (CollectionUtils.isNotEmpty(nodeList)) {
                /*单个文件*/
                if (nodeList.size() == 1) {
                    Node node = nodeList.get(0);
                    byte[] body = FileDownoadUtil.downloadWj(node.getId());
                    String fileName = node.getName();
                    String file = Base64.getEncoder().encodeToString(body);
                    Map<String, String> sjcl = new HashMap<>();
                    sjcl.put(fileName, file);
                    sjclList.add(sjcl);
                } else {
                    for (Node node : nodeList) {
                        byte[] body = FileDownoadUtil.downloadWj(node.getId());
                        String fileName = node.getName();
                        String file = Base64.getEncoder().encodeToString(body);
                        Map<String, String> sjcl = new HashMap<>();
                        sjcl.put(fileName, file);
                        sjclList.add(sjcl);
                    }
                }
            }
        } catch (Exception e) {
            logger.error("错误原因:{}", e);
        }
        return sjclList;
    }

    private List<DchyXmglHtxxDto> generateHtxxList(String chxmid, String newChxmid, String newChdwxxid, List newClsxList, List oldClsxidList) {
        List<DchyXmglHtxxDto> dchyXmglHtxxDtoList = Lists.newArrayList();
        List<DchyXmglHtxxChdwxxGx> dchyXmglHtxxChdwxxGxList = Lists.newArrayList();
        List<DchyXmglClsxHtxxGx> dchyXmglClsxHtxxGxList = Lists.newArrayList();
        List<DchyXmglClsxChdwxxGx> dchyXmglClsxChdwxxGxList = Lists.newArrayList();
        List<DchyXmglSjxx> dchyXmglSjxxList = Lists.newArrayList();
        List<DchyXmglSjcl> dchyXmglSjclList = Lists.newArrayList();

        //获取当前阶段下全部的合同id
        Set set = new HashSet();
        List<String> oldHtxxidList = Lists.newArrayList();
        Example exampleClsxHtxxGx = new Example(DchyXmglClsxHtxxGx.class);
        exampleClsxHtxxGx.createCriteria().andEqualTo("chxmid", chxmid).andIn("clsxid", oldClsxidList);
        List<DchyXmglClsxHtxxGx> oldClsxHtxxGxList = entityMapper.selectByExampleNotNull(exampleClsxHtxxGx);
        if (CollectionUtils.isNotEmpty(oldClsxHtxxGxList)) {
            for (DchyXmglClsxHtxxGx oldClsxHtxxGx : oldClsxHtxxGxList) {
                if(set.add(StringUtils.isNotEmpty(oldClsxHtxxGx.getHtxxid()))){
                    oldHtxxidList.add(oldClsxHtxxGx.getHtxxid());
                }
            }

            //拆分合同
            if(CollectionUtils.isNotEmpty(oldHtxxidList)){
                for(String htxxid : oldHtxxidList){
                    DchyXmglHtxxDto dchyXmglHtxxDto = new DchyXmglHtxxDto();
                    if (StringUtils.isNotEmpty(htxxid)) {
                        DchyXmglHtxx oldDchyXmglHtxx = entityMapper.selectByPrimaryKey(DchyXmglHtxx.class, htxxid);
                        String newHtxxid = UUIDGenerator.generate18();
                        oldDchyXmglHtxx.setHtxxid(newHtxxid);
                        oldDchyXmglHtxx.setChxmid(newChxmid);
                        entityMapper.saveOrUpdate(oldDchyXmglHtxx, oldDchyXmglHtxx.getHtxxid());
                        dchyXmglHtxxDto.setDchyXmglHtxx(oldDchyXmglHtxx);

                        //更新组织收件信息
                        List<Map<String, List>> htFileList = new ArrayList<>();
                        Example exampleSjxx = new Example(DchyXmglSjxx.class);
                        exampleSjxx.createCriteria().andEqualTo("glsxid", htxxid);
                        List<DchyXmglSjxx> oldDchyXmglSjxxList = entityMapper.selectByExampleNotNull(exampleSjxx);
                        if (CollectionUtils.isNotEmpty(oldDchyXmglSjxxList)) {
                            for (DchyXmglSjxx oldDchyXmglSjxx : oldDchyXmglSjxxList) {
                                String htsjclid = oldDchyXmglSjxx.getSjxxid();
                                String newSjxxid = UUIDGenerator.generate18();
                                oldDchyXmglSjxx.setSjxxid(newSjxxid);
                                oldDchyXmglSjxx.setGlsxid(newHtxxid);
                                entityMapper.saveOrUpdate(oldDchyXmglSjxx, oldDchyXmglSjxx.getSjxxid());
                                dchyXmglSjxxList.add(oldDchyXmglSjxx);

                                Example exampleSjcl1 = new Example(DchyXmglSjcl.class);
                                exampleSjcl1.createCriteria().andEqualTo("sjxxid", htsjclid);
                                List<DchyXmglSjcl> oldDchyXmglSjclList1 = entityMapper.selectByExampleNotNull(exampleSjcl1);
                                if (CollectionUtils.isNotEmpty(oldDchyXmglSjclList1)) {
                                    for (DchyXmglSjcl oldDchyXmglSjclLists1 : oldDchyXmglSjclList1) {
                                        if (StringUtils.isNotEmpty(oldDchyXmglSjclLists1.getClmc())) {
                                            String newSjclid = UUIDGenerator.generate18();
                                            oldDchyXmglSjclLists1.setSjclid(newSjclid);
                                            oldDchyXmglSjclLists1.setSjxxid(newSjxxid);
                                            entityMapper.saveOrUpdate(oldDchyXmglSjclLists1, oldDchyXmglSjclLists1.getSjclid());
                                            dchyXmglSjclList.add(oldDchyXmglSjclLists1);

                                            /*生成合同文件*/
                                            List<Map<String, String>> htFile;
                                            Map<String, List> listMap = new HashMap<>();
                                            String wjzxid = oldDchyXmglSjclLists1.getWjzxid();
                                            if (StringUtils.isNotBlank(wjzxid)) {
                                                htFile = this.generateFileByWjzxid(Integer.parseInt(wjzxid));
                                                if(htFile != null){
                                                    listMap.put(oldDchyXmglSjclLists1.getSjclid(), htFile);
                                                    htFileList.add(listMap);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            dchyXmglHtxxDto.setDchyXmglSjxxList(dchyXmglSjxxList);
                            dchyXmglHtxxDto.setDchyXmglSjclList(dchyXmglSjclList);
                            dchyXmglHtxxDto.setHtFileList(htFileList);
                        }

                        //合同与测绘单位
                        if (StringUtils.isNotEmpty(newChdwxxid)) {
                            DchyXmglHtxxChdwxxGx dchyXmglHtxxChdwxxGx = new DchyXmglHtxxChdwxxGx();
                            String newGxid = UUIDGenerator.generate18();
                            dchyXmglHtxxChdwxxGx.setGxid(newGxid);
                            dchyXmglHtxxChdwxxGx.setHtxxid(newHtxxid);
                            dchyXmglHtxxChdwxxGx.setChdwxxid(newChdwxxid);
                            dchyXmglHtxxChdwxxGx.setChxmid(newChxmid);
                            entityMapper.saveOrUpdate(dchyXmglHtxxChdwxxGx, dchyXmglHtxxChdwxxGx.getGxid());
                            dchyXmglHtxxChdwxxGxList.add(dchyXmglHtxxChdwxxGx);
                            dchyXmglHtxxDto.setDchyXmglHtxxChdwxxGxList(dchyXmglHtxxChdwxxGxList);
                        }

                        //获取测绘阶段，拆分组织测绘项目测绘事项
                        Iterator<String> iterator = newClsxList.iterator();
                        while (iterator.hasNext()) {
                            String newClsxid = iterator.next();
                            //合同测量事项
                            DchyXmglClsxHtxxGx dchyXmglClsxHtxxGx = new DchyXmglClsxHtxxGx();
                            dchyXmglClsxHtxxGx.setGxid(UUIDGenerator.generate18());
                            dchyXmglClsxHtxxGx.setClsxid(newClsxid);
                            dchyXmglClsxHtxxGx.setHtxxid(newHtxxid);
                            dchyXmglClsxHtxxGx.setChxmid(newChxmid);
                            entityMapper.saveOrUpdate(dchyXmglClsxHtxxGx, dchyXmglClsxHtxxGx.getGxid());
                            dchyXmglClsxHtxxGxList.add(dchyXmglClsxHtxxGx);

                            //更新测量事项与测绘单位关系
                            DchyXmglClsxChdwxxGx dchyXmglClsxChdwxxGx = new DchyXmglClsxChdwxxGx();
                            dchyXmglClsxChdwxxGx.setGxid(UUIDGenerator.generate18());
                            dchyXmglClsxChdwxxGx.setClsxid(newClsxid);
                            dchyXmglClsxChdwxxGx.setChdwxxid(newChdwxxid);
                            entityMapper.saveOrUpdate(dchyXmglClsxChdwxxGx, dchyXmglClsxChdwxxGx.getGxid());
                            dchyXmglClsxChdwxxGxList.add(dchyXmglClsxChdwxxGx);
                        }
                        dchyXmglHtxxDto.setDchyXmglClsxHtxxGxList(dchyXmglClsxHtxxGxList);
                        dchyXmglHtxxDto.setDchyXmglClsxChdwxxGxList(dchyXmglClsxChdwxxGxList);
                    }
                    dchyXmglHtxxDtoList.add(dchyXmglHtxxDto);
                }
            }
        }


        return dchyXmglHtxxDtoList;
    }

    private List<DchyXmglHtxxDto> generateHtList(String chxmid) {
        List<DchyXmglHtxxDto> dchyXmglHtxxDtoList = Lists.newArrayList();
        List<DchyXmglSjxx> dchyXmglSjxxList = Lists.newArrayList();
        List<DchyXmglSjcl> dchyXmglSjclList = Lists.newArrayList();

        Example exampleHtxx = new Example(DchyXmglHtxx.class);
        exampleHtxx.createCriteria().andEqualTo("chxmid", chxmid);
        List<DchyXmglHtxx> oldDchyXmglHtxxList = entityMapper.selectByExampleNotNull(exampleHtxx);
        if (CollectionUtils.isNotEmpty(oldDchyXmglHtxxList)) {
            DchyXmglHtxxDto dchyXmglHtxxDto = new DchyXmglHtxxDto();

            for (DchyXmglHtxx oldDchyXmglHtxx : oldDchyXmglHtxxList) {
                String htxxid = oldDchyXmglHtxx.getHtxxid();
                dchyXmglHtxxDto.setDchyXmglHtxx(oldDchyXmglHtxx);

                //组织收件信息
                Example exampleSjxxHt = new Example(DchyXmglSjxx.class);
                exampleSjxxHt.createCriteria().andEqualTo("glsxid", htxxid);
                List<DchyXmglSjxx> dchyXmglSjxxHtList = entityMapper.selectByExampleNotNull(exampleSjxxHt);
                if (CollectionUtils.isNotEmpty(dchyXmglSjxxHtList)) {
                    for (DchyXmglSjxx dchyXmglSjxxHt : dchyXmglSjxxHtList) {
                        String htsjclid = dchyXmglSjxxHt.getSjxxid();
                        dchyXmglSjxxList.add(dchyXmglSjxxHt);

                        //收件材料
                        Example exampleSjclHt = new Example(DchyXmglSjcl.class);
                        exampleSjclHt.createCriteria().andEqualTo("sjxxid", htsjclid);
                        List<DchyXmglSjcl> dchyXmglSjclHtList = entityMapper.selectByExampleNotNull(exampleSjclHt);
                        if (CollectionUtils.isNotEmpty(dchyXmglSjclHtList)) {
                            for (DchyXmglSjcl dchyXmglSjclHt : dchyXmglSjclHtList) {
                                dchyXmglSjclList.add(dchyXmglSjclHt);
                            }
                        }
                    }
                }

                //合同与测绘单位
                Example exampleHtChdwxx = new Example(DchyXmglHtxxChdwxxGx.class);
                exampleHtChdwxx.createCriteria().andEqualTo("htxxid", htxxid);
                List<DchyXmglHtxxChdwxxGx> dchyXmglSjclHtList = entityMapper.selectByExampleNotNull(exampleHtChdwxx);
                dchyXmglHtxxDto.setDchyXmglHtxxChdwxxGxList(dchyXmglSjclHtList);

                //合同测量事项
                Example exampleHtClsx = new Example(DchyXmglClsxHtxxGx.class);
                exampleHtClsx.createCriteria().andEqualTo("htxxid", htxxid);
                List<DchyXmglClsxHtxxGx> dchyXmglClsxHtxxGxList = entityMapper.selectByExampleNotNull(exampleHtClsx);
                dchyXmglHtxxDto.setDchyXmglClsxHtxxGxList(dchyXmglClsxHtxxGxList);

                //更新测量事项与测绘单位关系
                Example exampleClsxChdwxxGx = new Example(DchyXmglClsxChdwxxGx.class);
                exampleClsxChdwxxGx.createCriteria().andEqualTo("htxxid", htxxid);
                List<DchyXmglClsxChdwxxGx> dchyXmglClsxChdwxxGxList = entityMapper.selectByExampleNotNull(exampleClsxChdwxxGx);
                dchyXmglHtxxDto.setDchyXmglClsxChdwxxGxList(dchyXmglClsxChdwxxGxList);
                dchyXmglHtxxDtoList.add(dchyXmglHtxxDto);
            }
        }
        return dchyXmglHtxxDtoList;
    }

    private List<DchyXmglYhxx> generateYhxx(String xmmc, String wtdw, String chxmid, String
            sftg, List<Map<String, Object>> chdwxxList) {
        String xxnr = null;
        String xxlx = null;
        String sftz = null;
        String yhxxpzid = null;
        DchyXmglChxm dchyXmglChxm = entityMapper.selectByPrimaryKey(DchyXmglChxm.class, chxmid);
        if (dchyXmglChxm != null) {
            String wtzt = dchyXmglChxm.getWtzt();
            if (StringUtils.isNotEmpty(wtzt)) {
                if (StringUtils.equals(sftg, "1")) {
                    yhxxpzid = Constants.DCHY_XMGL_ZD_XXNR_XSWTSHTG;
                } else if (StringUtils.equals(sftg, "0")) {
                    yhxxpzid = Constants.DCHY_XMGL_ZD_XXNR_XSWTSHBTG;
                }
            } else {
                if (StringUtils.equals(sftg, "1")) {
                    yhxxpzid = Constants.DCHY_XMGL_ZD_XXNR_HTBAYTG;
                } else if (StringUtils.equals(sftg, "0")) {
                    yhxxpzid = Constants.DCHY_XMGL_ZD_XXNR_HTBAYBTG;
                }
            }
        }

        List<DchyXmglYhxx> dchyXmglYhxxList = Lists.newArrayList();
        Example example = new Example(DchyXmglYhxxPz.class);
        example.createCriteria().andEqualTo("id", yhxxpzid);
        List<DchyXmglYhxxPz> xxnrzd = entityMapper.selectByExampleNotNull(example);

        if (CollectionUtils.isNotEmpty(xxnrzd)) {
            for (DchyXmglYhxxPz xxnrzds : xxnrzd) {
                if (StringUtils.isNotEmpty(xmmc)) {
                    xxnr = xxnrzds.getXxnr().replaceAll("项目名称", xmmc);
                } else {
                    xxnr = xxnrzds.getXxnr();
                }
                xxlx = xxnrzds.getXxlx();
                sftz = xxnrzds.getSftz();
            }
        }
        //测绘单位提醒消息
        if (chdwxxList != null) {
            for (Map<String, Object> chdwxxLists : chdwxxList) {
                DchyXmglYhxx dchyXmglYhxx = new DchyXmglYhxx();
                dchyXmglYhxx.setFsyhid(UserUtil.getCurrentUserId());
                dchyXmglYhxx.setFssj(CalendarUtil.getCurHMSDate());
                dchyXmglYhxx.setDqzt(Constants.INVALID);//未读
                dchyXmglYhxx.setYhxxid(UUIDGenerator.generate18());
                String jsyhid = MapUtils.getString(chdwxxLists, "chdwid");
                dchyXmglYhxx.setJsyhid(jsyhid);
                dchyXmglYhxx.setGlsxid(chxmid);
                dchyXmglYhxx.setXxnr(xxnr); //消息内容
                dchyXmglYhxx.setXxlx(xxlx); //消息类型
                dchyXmglYhxx.setSftz(sftz); //是否跳转
                dchyXmglYhxxList.add(dchyXmglYhxx);
            }
        }
        //建设单位提醒消息
        if (StringUtils.isNotBlank(wtdw)) {
            DchyXmglYhxx dchyXmglYhxx = new DchyXmglYhxx();
            dchyXmglYhxx.setFsyhid(UserUtil.getCurrentUserId());
            dchyXmglYhxx.setFssj(CalendarUtil.getCurHMSDate());
            dchyXmglYhxx.setDqzt(Constants.INVALID);//未读
            dchyXmglYhxx.setYhxxid(UUIDGenerator.generate18());
            dchyXmglYhxx.setJsyhid(wtdw);
            dchyXmglYhxx.setGlsxid(chxmid);
            dchyXmglYhxx.setXxnr(xxnr); //消息内容
            dchyXmglYhxx.setXxlx(xxlx); //消息类型
            dchyXmglYhxx.setSftz(sftz); //是否跳转
            dchyXmglYhxxList.add(dchyXmglYhxx);
        }
        return dchyXmglYhxxList;
    }

    @Override
    public Page<Map<String, Object>> getCommissionTask(Map<String, Object> param) {
        Page<Map<String, Object>> resultList = null;
        try {
            Map<String, Object> data = (Map<String, Object>) param.get("data");
            String gcbh = CommonUtil.formatEmptyValue(data.get("gcbh"));
            String gcmc = CommonUtil.formatEmptyValue(data.get("gcmc"));
            String babh = CommonUtil.formatEmptyValue(data.get("babh"));
            String jsdwmc = CommonUtil.formatEmptyValue(data.get("jsdwmc"));
            String chdwmc = CommonUtil.formatEmptyValue(data.get("chdwmc"));
            Map<String, Object> paramMap = Maps.newHashMap();
            paramMap.put("gcbh", gcbh);
            paramMap.put("gcmc", gcmc);
            paramMap.put("xqfbbh", babh);
            paramMap.put("wtdw", jsdwmc);
            paramMap.put("chdwmc", chdwmc);
            int page = Integer.parseInt(CommonUtil.formatEmptyValue(data.get("page")));
            int pageSize = Integer.parseInt(CommonUtil.formatEmptyValue(data.get("pageSize")));

            resultList = repository.selectPaging("queryCommissionTaskByPage", paramMap, page - 1, pageSize);

            if (CollectionUtils.isNotEmpty(resultList.getContent())) {
                for (Map<String, Object> mapTemp : resultList.getContent()) {
                    if (StringUtils.isNotEmpty(CommonUtil.ternaryOperator(mapTemp.get("WTZT")))) {
                        String wtztdm = CommonUtil.ternaryOperator(mapTemp.get("WTZT"));
                        DchyXmglZd zdWtzt = dchyXmglZdService.getDchyXmglByZdlxAndDm("WTZT", wtztdm);
                        if (zdWtzt != null) {
                            mapTemp.put("XMZT", zdWtzt.getMc());
                        }
                    }
                }
            }

        } catch (Exception e) {
            logger.error("错误信息:{}", e);
        }
        return resultList;
    }

    public String obtainBabh(String chxmid, String wtdw) {
        String babh = null;
        String jsdwm = null;
        String cljd = null;
        String babhLsh = dchyXmglChxmMapper.queryMaxBabh();
        if (StringUtils.isNotEmpty(babhLsh)) {
            if (babhLsh.length() > 4) {
                babhLsh = babhLsh.substring(babhLsh.length() - 4, babhLsh.length());
            }
        } else {
            babhLsh = "0001";
        }
        if (StringUtils.isNotEmpty(wtdw)) {
            Map<String, Object> paramMap = Maps.newHashMap();
            paramMap.put("dwmc", wtdw);
            List<Map<String, Object>> jsdwxx = dchyXmglJsdwMapper.queryJsdwList(paramMap);
            if (CollectionUtils.isNotEmpty(jsdwxx)) {
                jsdwm = MapUtils.getString(jsdwxx.get(0), "jsdwm");
                if (StringUtils.isEmpty(jsdwm)) {
                    jsdwm = ConstructionCodeUtil.getPinYinHeadChar(wtdw);
                }
            } else {
                if (StringUtils.isEmpty(jsdwm)) {
                    jsdwm = ConstructionCodeUtil.getPinYinHeadChar(wtdw);
                }
            }
        }
        if (StringUtils.isNotEmpty(chxmid)) {
            Example example = new Example(DchyXmglChxmClsx.class);
            example.createCriteria().andEqualTo("chxmid", chxmid);
            List<DchyXmglChxmClsx> clsxlist = entityMapper.selectByExampleNotNull(example);
            if (CollectionUtils.isNotEmpty(clsxlist)) {
                String clsx = clsxlist.get(0).getClsx();
                Example exampleZd = new Example(DchyXmglZd.class);
                exampleZd.createCriteria().andEqualTo("zdlx", "CLSX").andEqualTo("dm", clsx);
                List<DchyXmglZd> clsxzd = entityMapper.selectByExampleNotNull(exampleZd);
                if (CollectionUtils.isNotEmpty(clsxzd)) {
                    cljd = clsxzd.get(0).getQtsx();
                } else {
                    cljd = "XXXX";
                }
            }
        }
        babh = CalendarUtil.getCurStrYear() + babhLsh + XmbhFormatUtil.numberAfterFillZero(jsdwm, 6) + cljd;
        return babh;
    }


}
